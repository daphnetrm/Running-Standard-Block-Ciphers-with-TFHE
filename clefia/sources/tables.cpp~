#include "tables.h"
#include "bootstrapping.h"





word8 s0_0[256] = { 5, 4, 13, 12, 2, 3, 7, 15, 9, 6, 8, 14, 0, 11, 10, 1, 2, 13, 4, 9, 5, 14, 8, 11, 12, 0, 7, 3, 6, 15, 1, 10, 11, 10, 1, 6, 15, 7, 3, 2, 0, 12, 14, 8, 9, 5, 4, 13, 4, 5, 2, 14, 13, 9, 0, 1, 3, 8, 6, 12, 7, 10, 11, 15, 10, 11, 15, 8, 1, 0, 9, 13, 7, 14, 12, 6, 3, 4, 5, 2, 3, 9, 12, 13, 14, 5, 11, 8, 4, 1, 15, 2, 10, 7, 0, 6, 13, 2, 5, 3, 4, 12, 6, 10, 14, 7, 0, 9, 8, 1, 15, 11, 14, 12, 9, 4, 3, 2, 15, 7, 13, 10, 11, 5, 1, 8, 6, 0, 12, 14, 3, 5, 9, 13, 1, 0, 2, 11, 10, 4, 15, 6, 8, 7, 0, 7, 8, 15, 6, 10, 4, 12, 11, 2, 13, 1, 5, 9, 3, 14, 15, 1, 10, 0, 11, 8, 14, 5, 6, 9, 3, 7, 12, 2, 13, 4, 1, 15, 11, 7, 10, 6, 12, 4, 8, 3, 9, 0, 14, 13, 2, 5, 7, 0, 6, 1, 8, 11, 5, 14, 10, 13, 2, 15, 4, 3, 9, 12, 6, 8, 7, 11, 0, 1, 13, 9, 15, 5, 4, 10, 2, 12, 14, 3, 8, 6, 0, 10, 7, 15, 2, 3, 1, 4, 5, 11, 13, 14, 12, 9, 9, 3, 14, 2, 12, 4, 10, 6, 5, 15, 1, 13, 11, 0, 7, 8};

word8 s0_1[256] = { 7, 9, 1, 6, 15, 3, 4, 11, 5, 13, 2, 10, 14, 0, 8, 12, 8, 0, 11, 2, 12, 14, 5, 1, 4, 10, 6, 13, 3, 9, 7, 15, 15, 1, 9, 5, 7, 10, 2, 0, 6, 14, 4, 3, 13, 11, 12, 8, 2, 13, 14, 8, 4, 11, 15, 3, 12, 9, 7, 0, 1, 10, 6, 5, 4, 14, 13, 12, 2, 0, 7, 10, 8, 1, 15, 11, 9, 3, 5, 6, 0, 8, 12, 13, 11, 4, 3, 15, 14, 6, 10, 2, 5, 7, 9, 1, 6, 10, 3, 7, 5, 1, 12, 14, 15, 0, 8, 9, 11, 13, 2, 4, 9, 7, 15, 10, 1, 5, 14, 12, 3, 2, 13, 6, 4, 8, 0, 11, 13, 2, 4, 0, 14, 12, 1, 5, 11, 7, 9, 8, 15, 6, 10, 3, 3, 5, 6, 1, 10, 7, 0, 2, 9, 12, 11, 15, 8, 4, 14, 13, 12, 11, 0, 4, 8, 13, 6, 9, 2, 3, 5, 14, 10, 1, 15, 7, 5, 3, 10, 15, 6, 9, 8, 13, 7, 11, 12, 1, 0, 14, 4, 2, 11, 12, 8, 14, 0, 2, 10, 7, 13, 5, 3, 4, 6, 15, 1, 9, 14, 4, 2, 11, 13, 8, 9, 6, 0, 15, 1, 12, 7, 5, 3, 10, 1, 15, 7, 3, 9, 6, 13, 8, 10, 4, 14, 5, 2, 12, 11, 0, 10, 6, 5, 9, 3, 15, 11, 4, 1, 8, 0, 7, 12, 2, 13, 14};

word8 s1_0[256] = { 6, 13, 12, 14, 4, 9, 0, 3, 11, 3, 11, 3, 1, 3, 0, 13, 11, 7, 9, 8, 11, 9, 14, 13, 9, 0, 4, 4, 9, 2, 11, 9, 1, 14, 12, 11, 9, 14, 4, 6, 14, 2, 2, 3, 14, 1, 13, 0, 9, 1, 12, 3, 2, 8, 10, 11, 2, 12, 12, 0, 5, 15, 8, 8, 15, 15, 13, 2, 12, 10, 8, 12, 13, 6, 5, 12, 10, 14, 4, 5, 2, 5, 9, 3, 14, 3, 0, 13, 8, 15, 6, 8, 11, 0, 7, 5, 6, 5, 1, 6, 15, 3, 3, 5, 10, 1, 13, 2, 3, 15, 10, 5, 12, 14, 14, 7, 3, 5, 0, 7, 6, 12, 12, 4, 1, 13, 10, 9, 5, 0, 12, 8, 3, 7, 8, 14, 4, 1, 9, 9, 5, 13, 8, 1, 9, 3, 0, 2, 6, 7, 10, 5, 4, 0, 8, 13, 6, 2, 12, 6, 7, 6, 11, 7, 10, 7, 0, 13, 4, 8, 2, 1, 15, 14, 8, 10, 7, 4, 12, 2, 13, 5, 4, 7, 6, 1, 2, 15, 12, 11, 4, 10, 11, 2, 4, 3, 13, 1, 4, 7, 12, 0, 15, 14, 15, 14, 15, 10, 15, 5, 10, 15, 1, 4, 8, 13, 11, 4, 2, 10, 5, 11, 10, 15, 13, 7, 6, 11, 6, 9, 5, 0, 0, 3, 7, 8, 1, 8, 11, 10, 15, 14, 7, 9, 10, 15, 6, 11, 6, 0, 14, 2, 7, 1, 9, 1};

word8 s1_1[256] = { 12, 10, 3, 9, 14, 13, 10, 13, 8, 6, 4, 8, 3, 4, 12, 9, 15, 4, 4, 15, 7, 12, 5, 12, 14, 7, 9, 15, 8, 12, 0, 3, 2, 11, 13, 3, 2, 7, 1, 0, 3, 1, 7, 11, 6, 9, 2, 14, 1, 1, 7, 15, 10, 14, 1, 12, 11, 8, 5, 15, 11, 3, 7, 11, 11, 5, 14, 0, 6, 7, 4, 14, 8, 5, 1, 9, 4, 15, 3, 3, 5, 13, 11, 1, 8, 14, 13, 7, 0, 15, 9, 10, 10, 11, 3, 12, 14, 4, 5, 2, 6, 5, 0, 2, 3, 6, 3, 8, 2, 10, 10, 14, 15, 10, 13, 8, 3, 8, 9, 11, 3, 0, 1, 6, 14, 15, 9, 9, 5, 4, 4, 6, 9, 7, 2, 12, 0, 8, 0, 7, 9, 13, 3, 15, 10, 7, 6, 4, 4, 12, 5, 6, 8, 8, 5, 0, 1, 6, 10, 15, 14, 10, 6, 1, 0, 0, 5, 1, 5, 12, 3, 12, 0, 14, 9, 13, 10, 11, 2, 15, 11, 10, 13, 6, 7, 7, 13, 4, 11, 1, 10, 8, 5, 2, 7, 10, 5, 0, 12, 2, 12, 0, 9, 0, 13, 2, 14, 14, 8, 15, 11, 1, 11, 2, 1, 6, 14, 4, 9, 6, 7, 9, 15, 2, 4, 5, 6, 11, 8, 15, 0, 2, 1, 12, 15, 13, 10, 8, 13, 12, 7, 4, 9, 6, 2, 12, 13, 2, 11, 3, 1, 14, 13, 4, 5, 13};



word8 XOR_b16[256] = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 1, 0, 3, 2, 5, 4, 7, 6, 9, 8, 11, 10, 13, 12, 15, 14, 2, 3, 0, 1, 6, 7, 4, 5, 10, 11, 8, 9, 14, 15, 12, 13, 3, 2, 1, 0, 7, 6, 5, 4, 11, 10, 9, 8, 15, 14, 13, 12, 4, 5, 6, 7, 0, 1, 2, 3, 12, 13, 14, 15, 8, 9, 10, 11, 5, 4, 7, 6, 1, 0, 3, 2, 13, 12, 15, 14, 9, 8, 11, 10, 6, 7, 4, 5, 2, 3, 0, 1, 14, 15, 12, 13, 10, 11, 8, 9, 7, 6, 5, 4, 3, 2, 1, 0, 15, 14, 13, 12, 11, 10, 9, 8, 8, 9, 10, 11, 12, 13, 14, 15, 0, 1, 2, 3, 4, 5, 6, 7, 9, 8, 11, 10, 13, 12, 15, 14, 1, 0, 3, 2, 5, 4, 7, 6, 10, 11, 8, 9, 14, 15, 12, 13, 2, 3, 0, 1, 6, 7, 4, 5, 11, 10, 9, 8, 15, 14, 13, 12, 3, 2, 1, 0, 7, 6, 5, 4, 12, 13, 14, 15, 8, 9, 10, 11, 4, 5, 6, 7, 0, 1, 2, 3, 13, 12, 15, 14, 9, 8, 11, 10, 5, 4, 7, 6, 1, 0, 3, 2, 14, 15, 12, 13, 10, 11, 8, 9, 6, 7, 4, 5, 2, 3, 0, 1, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0};





// xor digit à digit v1 et v2
// renvoie le résultat dans v1
void XOR_fhe(vector <LweSample*> &v1,
	     vector <LweSample*> &v2,
	     TFheGateBootstrappingSecretKeySet* gk,
	     BaseBKeySwitchKey* ks_key) {
  vector <LweSample*> d0;
  vector <LweSample*> d1;
  vector <LweSample*> res0 (1);
  vector <LweSample*> res1 (1);
  d0.push_back(v1[0]);
  d0.push_back(v2[0]);
  d1.push_back(v1[1]);
  d1.push_back(v2[1]);
  res0[0] = new_LweSample(gk->lwe_key->params);
  deref_boot(res0, gk, d0, ks_key, XOR_b16, XOR_b16);
  res1[0] = new_LweSample(gk->lwe_key->params);
  deref_boot(res1, gk, d1, ks_key, XOR_b16, XOR_b16);
  res0.push_back(res1[0]);
  v1.swap(res0);
  d0.clear();
  d1.clear();
  res0.clear();
  res1.clear();
}




void testv_and(TorusPolynomial *testv, int32_t N, word8 tab[16]){
  uint32_t steps = N/16;
  for(int k = 0 ; k < 16 ; ++k) {
    for(int j = 0; j < steps; ++j) {
      testv->coefsT[steps*k + j] = dtot32((double)tab[k]/32);
    }   
  }
}


// remplacer pour la base 16 specifiquement 
void test_v0(TorusPolynomial *testv, int32_t N){
    for(int j = 0; j < N; ++j) 
      testv->coefsT[j] = dtot32(0.015625); // 1/64
}


void testv_vi_b16(IntPolynomial *testv, int32_t N, uint8_t idx, word8 tab[256]) {
  uint32_t steps = N/16;
  for(int k = 0 ; k < 16 ; ++k) {
    for(int j = 0; j < steps; ++j) {
      if(steps*k + j == 0)
	testv->coefs[0]= tab[16*idx]+tab[16*idx+15];
      else if((steps*k + j)%(steps)!=0)
	testv->coefs[steps*k + j]=0;
      else
	testv->coefs[steps*k + j] = (tab[16*idx + k]-tab[16*idx + k-1]);
    }
  } 
}



void tLweMulByXai(TLweSample *result,
		  int32_t ai,
		  const TLweSample *bk,
		  const TLweParams *params) {
    const int32_t k = params->k;
    for (int32_t i = 0; i <= k; i++)
        torusPolynomialMulByXai(&result->a[i], ai, &bk->a[i]);
}

void ks_batching(int i,
		 uint8_t B,
		 vector <LweSample*> &resLwe,
		 vector<TLweSample*> &resTLwe,
		 const TLweKey * k_out ,
		 BaseBKeySwitchKey* ks_key) {
      resTLwe[i/B] = new_TLweSample(k_out->params);
      BaseBExtra::KeySwitch_Id(resTLwe[i/B], ks_key, resLwe);
      for(int m = 0; m<B; ++m)
	delete_LweSample(resLwe[m]);
}



void Enc_tab (vector <LweSample*> tab_fhe[8],
	      word8 tab[8],
	      TFheGateBootstrappingSecretKeySet* key) {
  double alpha = key->lwe_key->params->alpha_min;
  for(int j = 0; j<8; ++j){
    tab_fhe[j].push_back(new_LweSample(key->lwe_key->params));
    lweSymEncrypt(tab_fhe[j][0], modSwitchToTorus32(tab[j]/16, 32), alpha, key->lwe_key);
    tab_fhe[j].push_back(new_LweSample(key->lwe_key->params));
    lweSymEncrypt(tab_fhe[j][1], modSwitchToTorus32(tab[j]%16, 32), alpha, key->lwe_key);
  }
}


void encode(word8 retour[8], uint64_t m){
  for(int j = 7; j>=0 ; j--)
    retour[7-j] = (m>>(8*j));
}




/*
void print_tables_Tx_b16(){
 printf("word8 XOR_b16 = { ");
  for(int i=0; i<255; ++i){
    printf("%d, ",XOR_b16[i]);
  }
  printf("%d};\n\n",(XOR_b16[255]));
  
  printf("word8 XOR_0_b16[256] = { ");
  for(int i=0; i<255; ++i){
    printf("%d, ",XOR_b16[i]%16);
  }
  printf("%d};\n\n",(XOR_b16[255]%16));
  printf("word8 XOR_1_b16[256] = { ");
  for(int i=0; i<255; ++i){
    printf("%d, ",(XOR_b16[i]/16));
  }
  printf("%d};\n\n",(XOR_b16[255]/16));
}


void print_tables_XOR(){
  printf("word8 XOR_b16[256] = {");
  for(int i = 0; i <16; ++i){
    for(int j = 0; j<16; ++j){
      printf("%d, ", i^j);
    }
  }
  printf("};\n\n");
}*/

